{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title> BusTracker </title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css" rel="stylesheet" />

        <style>
        	body { margin: 0; padding: 0; }
        	#map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: -1}
            #marker {
                background-image: url('/media/bus.png');
                background-size: cover;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                cursor: pointer;
            }

            .mapboxgl-popup {
                max-width: 200px;
            }
        </style>

    </head>
    <body>
    <h2 style="text-align: center"> BusTracker Нюрба </h2>
    <div id="map"></div>
    <script>
        function getBuses(){
            xhr.open('GET', 'http://egorovm.pythonanywhere.com/getInfo', false);
            xhr.send();

            if (xhr.status != 200) {
              return;
            }

            var response = JSON.parse(xhr.responseText);

            if(response["status"] == 0){
                return response["buses"];
            }
        }


        var bounds = [
            [118.260269, 63.244591],// Southwest coordinates
            [118.463925, 63.326944], // Northeast coordinates
        ];

        mapboxgl.accessToken = 'pk.eyJ1IjoiZWdvcm92bSIsImEiOiJjanhic2F1ZDUwMTdvNDJ0bHMxOGg5NWthIn0.QL2wIcgAJIBNIz2gbpuLVQ';

        var map;
        var xhr = new XMLHttpRequest();

        try{

            navigator.geolocation.getCurrentPosition(function(position) {
                    map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    zoom: 12,
                    center: [position.coords.latitude, position.coords.longitude],
                    //maxBounds: bounds
                });
            });
        }
        finally{
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                zoom: 4,
                center: [118.3447875, 63.2829217],
                maxBounds: bounds
            });
        }

        var buses = getBuses();
        var markets = [];

        for(var i = 0; i < buses.length; i++){
            var el = document.createElement('div');
            el.id = "marker";

            markets.push(new mapboxgl.Marker(el));

            var popup = new mapboxgl.Popup({ offset: 25 }).setText(
                'Construction on the Washington Monument began in 1848.'
            );

            markets[i].setPopup(popup);

        }

        var bus = new mapboxgl.Marker();

        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            })
        );

        function animateBuses(timestamp) {
            buses = getBuses();

            var radius = 20;

            // Update the data to a new position based on the animation timestamp. The
            // divisor in the expression `timestamp / 1000` controls the animation speed.

            markets.forEach((market, i) => {
                market.setLngLat([
                    buses[i].longitude,
                    buses[i].latitude
                ]);
                // Ensure it's added to the map. This is safe to call if it's already added.
                market.addTo(map);
            });

            // Request the next frame of the animation.
            setTimeout(requestAnimationFrame(animateBuses), 5000);
        }

        requestAnimationFrame(animateBuses);
    </script>

    </body>
</html>
