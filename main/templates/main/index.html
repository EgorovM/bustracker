<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title> BusTracker </title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css" rel="stylesheet" />

        <style>
        	body { margin: 0; padding: 0; }
        	#map { position: absolute; top: 0; bottom: 0; width: 100%; };
            .marker {
                background-image: url('https://www.google.com/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&ved=2ahUKEwjx6tSAg5rnAhUCqIsKHcS0CwIQjRx6BAgBEAQ&url=https%3A%2F%2Fwww.iconfinder.com%2Ficons%2F134058%2Fbus_icon&psig=AOvVaw0PSnezWglS_1YAbXqjW0tY&ust=1579879246961579');
                background-size: cover;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                cursor: pointer;
            }
        </style>

    </head>
    <body>
    <div id="map"></div>
    <script>
        function getBuses(){
            xhr.open('GET', '192.168.43.28:8000/getInfo', false);
            xhr.send();

            if (xhr.status != 200) {
              return;
            }

            var response = JSON.parse(xhr.responseText);

            if(response["status"] == 0){
                return response["buses"];
            }
        }


    	mapboxgl.accessToken = 'pk.eyJ1IjoiZWdvcm92bSIsImEiOiJjanhic2F1ZDUwMTdvNDJ0bHMxOGg5NWthIn0.QL2wIcgAJIBNIz2gbpuLVQ';
        var map;
        var xhr = new XMLHttpRequest();

        try{

            navigator.geolocation.getCurrentPosition(function(position) {
                    map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v10',
                    zoom: 12,
                    center: [position.coords.latitude, position.coords.longitude]
                });
            });
        }
        finally{
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v10',
                zoom: 12,
                center: [118.3447875, 63.2829217]
            });
        }

        var canvas = map.getCanvasContainer();

        var buses = getBuses();
        var market = [];

        var el = document.createElement('div');
        el.className = 'marker';

        for(var i = 0; i < buses.length; i++){
            market.push(new mapboxgl.Marker(el));
        }

        var bus = new mapboxgl.Marker();

        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            })
        );



        function animateBuses(timestamp) {
            buses = getBuses()

            var radius = 20;

            // Update the data to a new position based on the animation timestamp. The
            // divisor in the expression `timestamp / 1000` controls the animation speed.

            market.forEach((market, i) => {
                market.setLngLat([
                    buses[i].longitude,
                    buses[i].latitude
                ]);
                // Ensure it's added to the map. This is safe to call if it's already added.
                market.addTo(map);
            });



            // Request the next frame of the animation.
            setTimeout(requestAnimationFrame(animateBuses), 2000);
        }

        requestAnimationFrame(animateBuses);
    </script>

    </body>
</html>
